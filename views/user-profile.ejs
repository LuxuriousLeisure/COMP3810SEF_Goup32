<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= user.username %>'s Profile | Instagram Clone</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .user-profile-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .user-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ddd;
        }
        .user-stats {
            display: flex;
            gap: 1.5rem;
            margin: 1rem 0;
        }
        .stat-item {
            font-size: 1rem;
        }
        .follow-btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        .follow-btn.follow {
            background-color: #0095f6;
            color: white;
        }
        .follow-btn.unfollow {
            background-color: #efefef;
            color: #262626;
            border: 1px solid #dbdbdb;
        }
        .follow-btn:hover {
            opacity: 0.9;
        }
        .error-message {
            color: #ed4956;
            margin: 1rem 0;
        }
        .success-message {
            color: #4cb5f9;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- 导航栏（复用项目现有导航） -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/home" class="logo">Instagram Clone</a>
            <div class="nav-links">
                <a href="/home">Home</a>
                <a href="/publish">Publish</a>
                <a href="/following">Following</a>
                <a href="/followers">Followers</a>
                <a href="/logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="user-profile-container">
        <div class="user-header">
            <img src="<%= user.profileImage || '/images/default-avatar.png' %>" alt="<%= user.username %>" class="avatar">
            <div class="user-info">
                <h1><%= user.username %></h1>
                <div class="user-stats">
                    <div class="stat-item"><%= user.postCount || 0 %> posts</div>
                    <div class="stat-item"><%= user.followerCount || 0 %> followers</div>
                    <div class="stat-item"><%= user.followingCount || 0 %> following</div>
                </div>
                
                <!-- 关注/取消关注按钮 -->
                <% if (currentUser && currentUser._id.toString() !== user._id.toString()) { %>
                    <div id="message" class=""></div>
                    <button 
                        id="followBtn" 
                        class="follow-btn <%= isFollowing ? 'unfollow' : 'follow' %>"
                        data-followee-id="<%= user._id %>"
                    >
                        <%= isFollowing ? 'Unfollow' : 'Follow' %>
                    </button>
                <% } %>
            </div>
        </div>

        <!-- 用户帖子区域（复用项目现有帖子展示逻辑） -->
        <div class="posts-container">
            <h2>Posts</h2>
            <% if (user.posts && user.posts.length > 0) { %>
                <div class="posts-grid">
                    <% user.posts.forEach(post => { %>
                        <div class="post-card">
                            <img src="<%= post.images[0] %>" alt="Post by <%= user.username %>" class="post-image">
                            <p class="post-content"><%= post.content %></p>
                            <p class="post-likes"><%= post.likeCount || 0 %> likes</p>
                        </div>
                    <% }) %>
                </div>
            <% } else { %>
                <p>No posts yet.</p>
            <% } %>
        </div>
    </div>

    <script>
        // 关注/取消关注逻辑
        const followBtn = document.getElementById('followBtn');
        const messageDiv = document.getElementById('message');

        if (followBtn) {
            followBtn.addEventListener('click', async () => {
                const followeeId = followBtn.getAttribute('data-followee-id');
                const isCurrentlyFollowing = followBtn.classList.contains('unfollow');
                
                try {
                    let response;
                    if (isCurrentlyFollowing) {
                        // 取消关注
                        response = await fetch(`/api/unfollow/${followeeId}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });
                    } else {
                        // 关注
                        response = await fetch(`/api/follow/${followeeId}`, {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                    }

                    const data = await response.json();
                    if (data.success) {
                        // 更新按钮状态和提示
                        messageDiv.className = 'success-message';
                        messageDiv.textContent = data.message;
                        followBtn.classList.toggle('follow');
                        followBtn.classList.toggle('unfollow');
                        followBtn.textContent = isCurrentlyFollowing ? 'Follow' : 'Unfollow';
                        
                        // 刷新页面更新粉丝/关注数（可选：也可手动更新DOM）
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        messageDiv.className = 'error-message';
                        messageDiv.textContent = data.message;
                    }
                } catch (error) {
                    messageDiv.className = 'error-message';
                    messageDiv.textContent = 'Operation failed. Please try again.';
                    console.error('Follow/unfollow error:', error);
                }
            });
        }
    </script>
</body>
</html>
